/*
 fe-project-5 2016-02-21 
*/
function getZomato(a){var b;this.vendorData=Control.getVendor("Zomato");var c=this.vendorData[0].startUrl+a.locationID+"&apikey="+this.vendorData[0].key;$.getJSON(c,function(a){b='<div class="infowindow"><h3>'+a.name+"</h3><p>"+a.location.address+"<br><strong>Cuisine:</strong> "+a.cuisines+"<br><strong>Average Cost for Two:</strong> $"+a.average_cost_for_two+"</br><strong>Average Zomato Rating:</strong> "+a.user_rating.aggregate_rating+" ("+a.user_rating.rating_text+')</p><p id="vendor-credits"><a href="'+a.url+'" target="new">Powered by Zomato</a></p><div>',"https://b.zmtcdn.com/images/res_avatar_120_1x_new.png"!==a.thumb&&(b=b+'<div class=infowindow><p><img src="'+a.thumb+'"></p></div>')}).done(function(){infowindow.setContent(b)}).fail(function(){infowindow.setContent(a.description)})}function getYelp(a){function b(){for(var a="",b="0123456789",c=0;9>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var c;this.vendorData=Control.getVendor("Yelp");var d="GET",e=vendorData[0].startUrl+a.locationID,f={oauth_consumer_key:this.vendorData[0].key.oauth_consumer_key,oauth_token:this.vendorData[0].key.oauth_token,oauth_nonce:b(),oauth_timestamp:Math.round((new Date).getTime()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb"},g=vendorData[0].key.consumerSecret,h=vendorData[0].key.tokenSecret,i=oauthSignature.generate(d,e,f,g,h),j=(oauthSignature.generate(d,e,f,g,h,{encodeSignature:!1}),e+"?oauth_consumer_key="+f.oauth_consumer_key+"&oauth_nonce="+f.oauth_nonce+"&oauth_signature_method="+f.oauth_signature_method+"&oauth_timestamp="+f.oauth_timestamp+"&oauth_token="+f.oauth_token+"&oauth_version="+f.oauth_version+"&oauth_signature="+i);$.ajax({type:"GET",url:j,cache:!0,jsonpCallback:"cb",dataType:"jsonp",success:function(a){c='<div class="infowindow"><h3>'+a.name+"</h3><p>"+a.location.display_address+"<br>Phone: "+a.display_phone+'<br><img src="'+a.rating_img_url+'"><br><strong>Rating:</strong> '+a.rating+'</p><p id="vendor-credits"><a href="'+a.url+'" target="new">Visit our Yelp Page</a></p><br><img src="'+a.image_url+'"><div>'}}).done(function(){infowindow.setContent(c)}).fail(function(){infowindow.setContent(a.description)})}function initMap(){function a(){b=map.getCenter()}map=new google.maps.Map(document.getElementById("map"),{zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},scaleControl:!0,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}});var b;google.maps.event.addDomListener(map,"idle",function(){a()}),google.maps.event.addDomListener(window,"resize",function(){map.setCenter(b)});var c=Control.getMyCoords();map.fitBounds(c[0]),allPlaces=Control.getAllPlaces(),initMarkers(allPlaces),initInfoWindow()}function initInfoWindow(){infowindow=new google.maps.InfoWindow({maxWidth:275})}function initMarkers(a){for(var b=0;b<a.length;b++){this.place=a[b];var c="./pix/"+place.icon;marker=new google.maps.Marker({animation:google.maps.Animation.DROP,position:place.position,map:map,icon:c,title:place.title}),marker.addListener("click",function(a){return function(){Control.setCurrentPlace(a),match(a)}}(place)),markers.push(marker)}}function match(a){for(var b=0;b<markers().length;b++)markers()[b].title==a.title&&(marker=markers()[b],map.panTo({lat:a.position.lat,lng:a.position.lng}),infowindow.open(map,marker),toggleBounce(a,marker),"Zomato"===a.source?getZomato(a):"Yelp"===a.source&&getYelp(a))}function toggleBounce(){null!==marker.getAnimation()?marker.setAnimation(null):(marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){marker.setAnimation(null)},750))}function ViewModel(){function a(a){a.matches?c.showMenu(!0):c.showMenu(!1)}var b,c=this,d=!1;c.filterStr=ko.observable(""),c.showMenu=ko.observable(b),c.showCredits=ko.observable(d),c.noMatches=ko.observable(0);for(var e=Control.getAllPlaces(),f=0;f<e.length;f++)e[f].visible=ko.observable(!0);if(c.places=ko.observableArray(e),matchMedia){var g=window.matchMedia("(min-width: 600px)");g.addListener(a),a(g)}this.toggleMenu=function(){return b=!b,c.showMenu(b)},this.toggleCredits=function(){return b=!b,c.showCredits(b)},this.showAll=function(){this.noMatches(0);for(var a=0;a<this.places().length;a++)this.places()[a].visible(!0),markers()[a].setMap(map)},this.filter=function(a){this.noMatches(0);for(var b=0,c=this.filterStr().toLowerCase(),d=0;d<this.places().length;d++){this.places()[d].visible(!0),markers()[d].setMap(map);var e=this.places()[d].description.toLowerCase()+" "+this.places()[d].title.toLowerCase()+" "+this.places()[d].type.toLowerCase()+this.places()[d].keys.toLowerCase(),f=e.search(c);-1==f&&(this.places()[d].visible(!1),markers()[d].setMap(null)),b+=f}document.getElementById("filter").reset(),this.filterStr(""),b==-1*this.places().length&&(this.showAll(),this.noMatches(1))}}var Model={currentPlace:null,myPlaces:[{position:{lat:35.883324,lng:-84.524148},map:map,title:"Mama Mia's Restaurant-Pizzeria",description:"Mama Mia's: Thin crust pizza and 70s decor",locationID:17269784,source:"Zomato",type:"Restaurant",keys:"pizza Italian Kingston all",icon:"pizza.png"},{position:{lat:35.885723,lng:-84.497461},map:map,title:"Gloria Jean's Restaurant",description:"Gloria Jean's: Southern cooking and hospitality",locationID:"gloria-jeans-kingston",source:"Yelp",type:"Restaurant",keys:"burgers sandwiches southern pie Kingston all",icon:"dinner.png"},{position:{lat:35.882102,lng:-84.505977},map:map,title:"Don Eduardo's Mexican Grill",description:"Don Eduardo's: A bit salty. Water, please?",locationID:17270326,source:"Zomato",type:"Restaurant",keys:"bar tequila beer Kingston all",icon:"dinner.png"},{position:{lat:35.87776,lng:-84.511819},map:map,title:"Mei Wei Chinese Restaurant",description:"Mei Wei: Far East food in Near East Tennessee",locationID:"17269786",source:"Zomato",type:"Restaurant",keys:"Chinese Asian Kingston all",icon:"dinner.png"},{position:{lat:35.874415,lng:-84.515031},map:map,title:"Handee Burger",description:"Handee Burger: Greasy, but no spoons",locationID:17269781,source:"Zomato",type:"Restaurant",keys:"breakfast biscuits gravy sliders Kingston all",icon:"hamburger.png"},{position:{lat:35.8611,lng:-84.527949},map:map,title:"Fort Southwest Point",description:"Fort Southwest Point: An early American fort",locationID:"fort-southwest-point-kingston",source:"Yelp",type:"Park",keys:"museum history cannon Kingston all",icon:"cannon.png"},{position:{lat:35.870925,lng:-84.515573},map:map,title:"Kingston Barber Shop",description:"Kingston Barber Shop: A great place for yourElvis-related looks",locationID:"kingston-barber-shop-kingston-3",source:"Yelp",type:"Barber",keys:"barber haircut trim Kingston all",icon:"barber.png"}],myVendors:[{vendor:"Zomato",key:"eae8f9e214a0616278ac70ef1df3dfce",startUrl:"https://developers.zomato.com/api/v2.1/restaurant?res_id="},{vendor:"Yelp",key:{oauth_consumer_key:"QTiph1Uz4Cpuw2kOa2sG3Q",oauth_token:"0gjDnn-g5CvZg-DOpgs4EuwJ2reEbVtN",consumerSecret:"YiK5tQt9n5ke2sSFQNof5GkJvHc",tokenSecret:"Edt0OgvUQHgQfqsP4HWeYkZaUT4"},startUrl:"https://api.yelp.com/v2/business/"}],myCoords:[{south:35.856494,west:-84.528388,north:35.886037,east:-84.507149}]},Control={setCurrentPlace:function(a){Model.currentPlace=a},getAllPlaces:function(){return Model.myPlaces},getVendor:function(a){for(var b=[],c=0;c<Model.myVendors.length;c++)Model.myVendors[c].vendor==a&&b.push(Model.myVendors[c]);return b},getMyCoords:function(){return Model.myCoords}},map,infowindow,allPlaces,markers=ko.observableArray();ko.applyBindings(new ViewModel);